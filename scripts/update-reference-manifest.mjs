#!/usr/bin/env node
import { promises as fs } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const rootDir = path.resolve(__dirname, "..");
const referencesDir = path.join(rootDir, "packages", "website", "references");
const manifestPath = path.join(rootDir, "packages", "cli", "src", "reference-manifest.ts");

async function collectMarkdownFiles(dir, prefix = "") {
  const entries = await fs.readdir(dir, { withFileTypes: true });
  const files = [];

  for (const entry of entries) {
    const relativePath = prefix ? `${prefix}/${entry.name}` : entry.name;
    const absolutePath = path.join(dir, entry.name);

    if (entry.isDirectory()) {
      files.push(...(await collectMarkdownFiles(absolutePath, relativePath)));
    } else if (/\.(md|mdx)$/i.test(entry.name)) {
      files.push(relativePath);
    }
  }

  return files;
}

async function main() {
  try {
    await fs.access(referencesDir);
  } catch {
    throw new Error(`References directory not found at ${referencesDir}`);
  }

  const files = (await collectMarkdownFiles(referencesDir)).sort((a, b) =>
    a.localeCompare(b),
  );

  const banner = "// Auto-generated by scripts/update-reference-manifest.mjs";
  const content = `${banner}\nexport const REFERENCE_FILES = ${JSON.stringify(files, null, 2)} as const;\n`;
  await fs.writeFile(manifestPath, content, "utf8");

  console.log(`Updated reference manifest with ${files.length} entries.`);
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
